#!/usr/bin/env python
"""
æ¼”ç¤ºé‡‘èé¢†åŸŸä¸“ç”¨æç¤ºè¯ç³»ç»Ÿçš„ä½¿ç”¨
Demo: Financial Domain-Specific Prompting System
"""

import asyncio
import os
from pathlib import Path
import sys

# æ·»åŠ æºä»£ç è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from haiku.rag.client import HaikuRAG
from haiku.rag.qa.financial_qa import (
    FinancialQuestionAnswerAgent,
    FinancialQuestionAnswerOpenAIAgent,
    FinancialQuestionAnswerOllamaAgent
)
from haiku.rag.qa.financial_prompts import get_intent_prompt


async def demo_intent_detection():
    """æ¼”ç¤ºæŸ¥è¯¢æ„å›¾è¯†åˆ«"""
    print("=== æŸ¥è¯¢æ„å›¾è¯†åˆ«æ¼”ç¤º ===\n")
    
    test_queries = [
        "è…¾è®¯2023å¹´çš„è¥æ”¶å’Œåˆ©æ¶¦æ˜¯å¤šå°‘ï¼Ÿ",
        "åˆ†æé•¿æ±Ÿå’Œè®°æ”¶è´­è‹±å›½ç”µä¿¡çš„äº¤æ˜“ç»“æ„",
        "è¿™ç¬”äº¤æ˜“æ˜¯å¦æ„æˆå…³è¿äº¤æ˜“ï¼Ÿéœ€è¦è‚¡ä¸œæ‰¹å‡†å—ï¼Ÿ",
        "æ¯”è¾ƒé˜¿é‡Œå·´å·´å’Œäº¬ä¸œçš„å¸‚ç›ˆç‡",
        "What is the EBITDA margin?",
        "Tell me about the acquisition terms and conditions"
    ]
    
    for query in test_queries:
        intent = get_intent_prompt(query)
        intent_type = "é€šç”¨æŸ¥è¯¢"
        
        if "FINANCIAL_DATA" in intent:
            intent_type = "è´¢åŠ¡æ•°æ®æå–"
        elif "TRANSACTION_ANALYSIS" in intent:
            intent_type = "äº¤æ˜“åˆ†æ"
        elif "COMPLIANCE_CHECK" in intent:
            intent_type = "åˆè§„æ£€æŸ¥"
        elif "COMPARATIVE_ANALYSIS" in intent:
            intent_type = "æ¯”è¾ƒåˆ†æ"
        
        print(f"æŸ¥è¯¢ï¼š{query}")
        print(f"æ„å›¾ï¼š{intent_type}")
        print("-" * 50)


async def demo_with_sample_data():
    """ä½¿ç”¨ç¤ºä¾‹æ•°æ®æ¼”ç¤ºé‡‘èé—®ç­”"""
    print("\n=== é‡‘èé—®ç­”ç³»ç»Ÿæ¼”ç¤º ===\n")
    
    # åˆ›å»ºå†…å­˜æ•°æ®åº“
    async with HaikuRAG(":memory:") as client:
        # æ·»åŠ ç¤ºä¾‹å…¬å‘Š
        sample_announcements = [
            """
é¦™æ¸¯äº¤æ˜“æ‰€ä¸Šå¸‚å…¬å¸å…¬å‘Š
è‚¡ä»½ä»£è™Ÿï¼š0700
å…¬å¸åç¨±ï¼šé¨°è¨Šæ§è‚¡æœ‰é™å…¬å¸

2023å¹´åº¦ç›ˆåˆ©å…¬å‘Š

è²¡å‹™æ‘˜è¦ï¼š
- ç¸½æ”¶å…¥ï¼šäººæ°‘å¹£6,090å„„å…ƒï¼ŒåŒæ¯”å¢é•·10%
- æ¯›åˆ©ï¼šäººæ°‘å¹£2,921å„„å…ƒï¼Œæ¯›åˆ©ç‡48%
- å¹´åº¦ç›ˆåˆ©ï¼šäººæ°‘å¹£1,882å„„å…ƒï¼ŒåŒæ¯”å¢é•·36%
- æ¯è‚¡åŸºæœ¬ç›ˆåˆ©ï¼šäººæ°‘å¹£19.92å…ƒ
- EBITDAï¼šäººæ°‘å¹£2,511å„„å…ƒï¼ŒEBITDAåˆ©æ½¤ç‡41%

è‘£äº‹æœƒå»ºè­°æ´¾ç™¼æœ«æœŸè‚¡æ¯æ¯è‚¡æ¸¯å¹£3.40å…ƒã€‚
""",
            """
é¦™æ¸¯äº¤æ˜“æ‰€ä¸Šå¸‚å…¬å¸å…¬å‘Š
è‚¡ä»½ä»£è™Ÿï¼š0001
å…¬å¸åç¨±ï¼šé•·æ±Ÿå’Œè¨˜å¯¦æ¥­æœ‰é™å…¬å¸

ä¸»è¦åŠé—œé€£äº¤æ˜“
æ”¶è³¼è‹±åœ‹é›»ä¿¡æ¥­å‹™

äº¤æ˜“è©³æƒ…ï¼š
- æ”¶è³¼ç›®æ¨™ï¼šUK Telecom Limited 100%è‚¡æ¬Š
- äº¤æ˜“ä»£åƒ¹ï¼šæ¸¯å¹£150å„„å…ƒ
- æ”¯ä»˜æ–¹å¼ï¼šç¾é‡‘ï¼Œåˆ†ä¸‰æœŸæ”¯ä»˜
  - é¦–æœŸ40%ï¼ˆæ¸¯å¹£60å„„å…ƒï¼‰ï¼šç°½ç´„æ™‚
  - ç¬¬äºŒæœŸ30%ï¼ˆæ¸¯å¹£45å„„å…ƒï¼‰ï¼šç›£ç®¡æ‰¹å‡†å¾Œ
  - å°¾æ¬¾30%ï¼ˆæ¸¯å¹£45å„„å…ƒï¼‰ï¼šäº¤å‰²å®Œæˆæ™‚

é—œé€£äº¤æ˜“æ€§è³ªï¼š
è³£æ–¹ç‚ºæœ¬å…¬å¸ä¸»è¦è‚¡æ±çš„è¯ç¹«äººï¼Œæ§‹æˆé—œé€£äº¤æ˜“ã€‚
æ ¹æ“šä¸Šå¸‚è¦å‰‡ç¬¬14Aç« ï¼Œéœ€è¦ç¨ç«‹è‚¡æ±æ‰¹å‡†ã€‚

è²¡å‹™å½±éŸ¿ï¼š
- é æœŸå¹´æ”¶å…¥è²¢ç»ï¼šæ¸¯å¹£20å„„å…ƒ
- é æœŸEBITDAè²¢ç»ï¼šæ¸¯å¹£5å„„å…ƒ
- é æœŸæŠ•è³‡å›å ±ç‡ï¼š15-18%
"""
        ]
        
        # æ·»åŠ æ–‡æ¡£
        for i, content in enumerate(sample_announcements, 1):
            await client.create_document(
                content=content,
                uri=f"announcement_{i}.txt",
                metadata={"source": f"HKEX Announcement {i}"}
            )
        
        # åˆ›å»ºé‡‘èé—®ç­”ä»£ç†
        agent = FinancialQuestionAnswerAgent(client)
        
        # æµ‹è¯•ä¸åŒç±»å‹çš„æŸ¥è¯¢
        test_queries = [
            "è…¾è®¯2023å¹´çš„è¥æ”¶æ˜¯å¤šå°‘ï¼Ÿ",
            "é•¿æ±Ÿå’Œè®°æ”¶è´­çš„äº¤æ˜“é‡‘é¢å’Œæ”¯ä»˜å®‰æ’æ˜¯ä»€ä¹ˆï¼Ÿ",
            "è¿™ç¬”æ”¶è´­æ˜¯å¦éœ€è¦è‚¡ä¸œæ‰¹å‡†ï¼Ÿ",
            "è…¾è®¯çš„EBITDAåˆ©æ¶¦ç‡æ˜¯å¤šå°‘ï¼Ÿ",
            "æ”¶è´­UK Telecomçš„é¢„æœŸå›æŠ¥ç‡ï¼Ÿ"
        ]
        
        for query in test_queries:
            print(f"\né—®é¢˜ï¼š{query}")
            print("-" * 80)
            
            answer = await agent.answer(query)
            print(answer)
            print("=" * 80)


async def demo_comparison():
    """æ¼”ç¤ºé€šç”¨æç¤ºè¯ vs é‡‘èæç¤ºè¯çš„å¯¹æ¯”"""
    print("\n=== é€šç”¨ vs é‡‘èæç¤ºè¯å¯¹æ¯” ===\n")
    
    # ç¤ºä¾‹æŸ¥è¯¢
    query = "åˆ†æè¿™ç¬”äº¤æ˜“çš„è´¢åŠ¡å½±å“å’Œé£é™©"
    
    print("æŸ¥è¯¢ï¼š", query)
    print("\né€šç”¨æç¤ºè¯ï¼š")
    print("-" * 50)
    print("ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ–‡æ¡£åˆ†æåŠ©æ‰‹...")
    print("ã€å·¥ä½œæµç¨‹ã€‘")
    print("1. ä½¿ç”¨ search_documents å·¥å…·æ£€ç´¢ç›¸å…³æ–‡æ¡£")
    print("2. ä»”ç»†é˜…è¯»æ¯ä¸ªæ£€ç´¢ç»“æœ")
    print("3. ä»æ–‡æ¡£ä¸­å¯»æ‰¾ç­”æ¡ˆ")
    
    print("\né‡‘èä¸“ç”¨æç¤ºè¯ï¼š")
    print("-" * 50)
    print("ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é‡‘èæ–‡æ¡£åˆ†æä¸“å®¶ï¼Œä¸“é—¨å¤„ç†æ¸¯äº¤æ‰€ä¸Šå¸‚å…¬å¸å…¬å‘Š...")
    print("ã€ä¸“ä¸šèƒ½åŠ›ã€‘")
    print("1. ç†è§£é‡‘èæœ¯è¯­å’Œæ¦‚å¿µ")
    print("2. è¯†åˆ«å’Œæå–å…³é”®è´¢åŠ¡æ•°æ®")
    print("3. åˆ†æäº¤æ˜“ç»“æ„å’Œæ¡æ¬¾")
    print("4. è¯„ä¼°ç›‘ç®¡åˆè§„è¦æ±‚")
    print("\nã€å½±å“åˆ†æè¦ç‚¹ã€‘")
    print("1. å¯¹å…¬å¸ä¸šåŠ¡çš„å½±å“")
    print("2. å¯¹è´¢åŠ¡çŠ¶å†µçš„å½±å“")
    print("3. å¯¹è‚¡æƒç»“æ„çš„å½±å“")
    print("4. æ½œåœ¨çš„ååŒæ•ˆåº”")


async def demo_structured_output():
    """æ¼”ç¤ºç»“æ„åŒ–è¾“å‡ºæ ¼å¼"""
    print("\n=== ç»“æ„åŒ–è¾“å‡ºæ ¼å¼æ¼”ç¤º ===\n")
    
    # è´¢åŠ¡æ•°æ®æ ¼å¼
    print("1. è´¢åŠ¡æ•°æ®æ ¼å¼ï¼š")
    print("-" * 50)
    print("""
ã€é¨°è¨Šæ§è‚¡æœ‰é™å…¬å¸ã€‘ç›ˆåˆ©å…¬å‘Š

ğŸ“Š å…³é”®è´¢åŠ¡æ•°æ®ï¼š
- æ€»æ”¶å…¥ï¼šäººæ°‘å¹£ 6,090 å„„å…ƒï¼ˆ+10%ï¼‰
- å¹´åº¦ç›ˆåˆ©ï¼šäººæ°‘å¹£ 1,882 å„„å…ƒï¼ˆ+36%ï¼‰
- æ¯›åˆ©ç‡ï¼š48%
- EBITDAåˆ©æ¶¦ç‡ï¼š41%

ğŸ“… é‡è¦æ—¥æœŸï¼š
- å…¬å‘Šæ—¥æœŸï¼š2024å¹´3æœˆ20æ—¥
- æ´¾æ¯æ—¥æœŸï¼š2024å¹´5æœˆ15æ—¥

ğŸ“ æ•°æ®è¯´æ˜ï¼š
- æ‰€æœ‰æ•°æ®ç»å®¡è®¡
- åŒæ¯”å¢é•¿åŸºäº2022å¹´æ•°æ®

ğŸ”— ä¿¡æ¯æ¥æºï¼š
åŸºäºæ–‡æ¡£ID: 1234, 2345
""")
    
    # äº¤æ˜“æ‘˜è¦æ ¼å¼
    print("\n2. äº¤æ˜“æ‘˜è¦æ ¼å¼ï¼š")
    print("-" * 50)
    print("""
ã€äº¤æ˜“æ¦‚è¦ã€‘æ”¶è´­UK Telecom Limited

ğŸ¢ äº¤æ˜“å„æ–¹ï¼š
- ä¹°æ–¹ï¼šé•·æ±Ÿå’Œè¨˜å¯¦æ¥­æœ‰é™å…¬å¸
- å–æ–¹ï¼šå…³è¿äººå£«ï¼ˆä¸»è¦è‚¡ä¸œè”ç³»äººï¼‰
- ç›®æ ‡ï¼šUK Telecom Limited

ğŸ’° äº¤æ˜“è¦ç´ ï¼š
- äº¤æ˜“é‡‘é¢ï¼šæ¸¯å¹£ 150 å„„å…ƒ
- è‚¡æƒæ¯”ä¾‹ï¼š100%
- æ”¯ä»˜æ–¹å¼ï¼šç°é‡‘åˆ†æœŸ

ğŸ“‹ å…³é”®æ¡æ¬¾ï¼š
- åˆ†ä¸‰æœŸæ”¯ä»˜ï¼ˆ40%-30%-30%ï¼‰
- éœ€è¦ç‹¬ç«‹è‚¡ä¸œæ‰¹å‡†
- éœ€è¦ç›‘ç®¡æ‰¹å‡†

âš ï¸ é£é™©æç¤ºï¼š
- å…³è¿äº¤æ˜“åˆè§„é£é™©
- æ•´åˆæ‰§è¡Œé£é™©
- ç›‘ç®¡å®¡æ‰¹ä¸ç¡®å®šæ€§

âœ… åç»­æ­¥éª¤ï¼š
1. å¬å¼€ç‹¬ç«‹è‘£äº‹ä¼šè®®
2. è˜è¯·ç‹¬ç«‹è´¢åŠ¡é¡¾é—®
3. å¬å¼€è‚¡ä¸œå¤§ä¼š
4. ç”³è¯·ç›‘ç®¡æ‰¹å‡†

ğŸ”— ä¿¡æ¯æ¥æºï¼š
åŸºäº2ä»½ç›¸å…³æ–‡æ¡£
""")


async def demo_error_handling():
    """æ¼”ç¤ºé”™è¯¯å¤„ç†"""
    print("\n=== é”™è¯¯å¤„ç†æ¼”ç¤º ===\n")
    
    error_scenarios = [
        {
            "scenario": "æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯",
            "message": "æ ¹æ®æ£€ç´¢åˆ°çš„æ–‡æ¡£ï¼Œæœªæ‰¾åˆ°å…³äºå°ç±³æ±½è½¦IPOçš„ç›¸å…³ä¿¡æ¯ã€‚å»ºè®®ï¼š\n1. å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯\n2. æ£€æŸ¥å…¬å¸åç§°æˆ–è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®\n3. ç¡®è®¤æ—¶é—´èŒƒå›´æ˜¯å¦åˆé€‚"
        },
        {
            "scenario": "ä¿¡æ¯ä¸å®Œæ•´",
            "message": "æ‰¾åˆ°éƒ¨åˆ†ç›¸å…³ä¿¡æ¯ï¼Œä½†ä»¥ä¸‹æ•°æ®ç¼ºå¤±ï¼š\n- äº¤æ˜“é‡‘é¢\n- å®Œæˆæ—¥æœŸ\n\nå·²è·å¾—ä¿¡æ¯ï¼š\n- äº¤æ˜“ç±»å‹ï¼šæ”¶è´­\n- ç›®æ ‡å…¬å¸ï¼šABC Limited"
        },
        {
            "scenario": "æŸ¥è¯¢ä¸æ˜ç¡®",
            "message": "æŸ¥è¯¢éœ€æ±‚ä¸å¤Ÿæ˜ç¡®ã€‚è¯·è¯´æ˜ï¼š\n1. å…·ä½“çš„å…¬å¸åç§°æˆ–è‚¡ç¥¨ä»£ç \n2. éœ€è¦æŸ¥è¯¢çš„ä¿¡æ¯ç±»å‹\n3. ç›¸å…³çš„æ—¶é—´èŒƒå›´"
        }
    ]
    
    for scenario in error_scenarios:
        print(f"åœºæ™¯ï¼š{scenario['scenario']}")
        print("-" * 50)
        print(scenario['message'])
        print()


async def demo_configuration():
    """æ¼”ç¤ºé…ç½®å’Œä½¿ç”¨æ–¹æ³•"""
    print("\n=== é…ç½®å’Œä½¿ç”¨æ–¹æ³• ===\n")
    
    print("1. ç¯å¢ƒå˜é‡é…ç½®ï¼š")
    print("-" * 50)
    print("""
# å¯ç”¨é‡‘èé—®ç­”ç³»ç»Ÿ
export USE_FINANCIAL_QA=true

# è®¾ç½®æ¨¡å‹ï¼ˆå¯é€‰ï¼‰
export FINANCIAL_QA_MODEL=gpt-4

# åŒæ—¶å¯ç”¨é‡‘èåˆ‡å—å™¨ï¼ˆæ¨èï¼‰
export USE_FINANCIAL_CHUNKER=true
""")
    
    print("\n2. ç¨‹åºå†…ä½¿ç”¨ï¼š")
    print("-" * 50)
    print("""
from haiku.rag.client import HaikuRAG
from haiku.rag.qa.financial_qa import FinancialQuestionAnswerOpenAIAgent

# åˆ›å»ºå®¢æˆ·ç«¯
async with HaikuRAG() as client:
    # åˆ›å»ºé‡‘èé—®ç­”ä»£ç†
    agent = FinancialQuestionAnswerOpenAIAgent(client, model="gpt-4")
    
    # æé—®
    answer = await agent.answer("åˆ†ææœ€æ–°çš„æ”¶è´­å…¬å‘Š")
    print(answer)
""")
    
    print("\n3. CLI ä½¿ç”¨ï¼ˆéœ€è¦é›†æˆï¼‰ï¼š")
    print("-" * 50)
    print("""
# ä½¿ç”¨é‡‘èæ¨¡å¼
haiku-rag chat --financial

# æˆ–é€šè¿‡ç¯å¢ƒå˜é‡
export USE_FINANCIAL_QA=true
haiku-rag chat
""")


async def main():
    """è¿è¡Œæ‰€æœ‰æ¼”ç¤º"""
    print("æ¸¯äº¤æ‰€å…¬å‘Šé‡‘èæç¤ºè¯ç³»ç»Ÿæ¼”ç¤º")
    print("=" * 80)
    
    # è¿è¡Œå„ä¸ªæ¼”ç¤º
    await demo_intent_detection()
    await demo_with_sample_data()
    await demo_comparison()
    await demo_structured_output()
    await demo_error_handling()
    await demo_configuration()
    
    print("\næ¼”ç¤ºå®Œæˆï¼")
    print("\nä¸»è¦ä¼˜åŠ¿ï¼š")
    print("1. è‡ªåŠ¨è¯†åˆ«æŸ¥è¯¢æ„å›¾ï¼Œé€‰æ‹©åˆé€‚çš„æç¤ºè¯")
    print("2. ç†è§£é‡‘èæœ¯è¯­ï¼Œæå–ç»“æ„åŒ–æ•°æ®")
    print("3. æä¾›ä¸“ä¸šçš„åˆ†ææ¡†æ¶")
    print("4. è¾“å‡ºæ ¼å¼åŒ–çš„ã€æ˜“è¯»çš„ç»“æœ")
    print("5. å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·å¼•å¯¼")


if __name__ == "__main__":
    asyncio.run(main())