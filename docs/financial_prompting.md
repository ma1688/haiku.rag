# 金融领域专用提示词系统指南

## 概述

haiku.rag 提供了专门针对港交所公告优化的金融领域提示词系统。该系统通过意图识别、专业提示词模板和结构化输出，显著提升金融文档的查询质量。

## 核心特性

### 1. 查询意图自动识别
系统自动识别查询类型并选择合适的提示词：
- **财务数据提取**：营收、利润、财务比率等
- **交易分析**：收购、合并、资产重组等
- **合规检查**：关连交易、披露要求等
- **比较分析**：公司对比、估值比较等

### 2. 专业金融提示词
每种查询类型都有专门优化的提示词模板：
- 理解金融术语（中英文）
- 提取结构化数据
- 识别关键条款
- 评估监管要求

### 3. 结构化输出格式
根据查询类型提供格式化输出：
- 财务数据表格
- 交易摘要报告
- 合规检查清单
- 比较分析图表

### 4. 金融术语支持
内置中英文金融术语词典，确保专业术语的准确理解和翻译。

## 配置使用

### 环境变量配置

```bash
# 启用金融问答系统
export USE_FINANCIAL_QA=true

# 指定金融查询专用模型（可选）
export FINANCIAL_QA_MODEL=gpt-4

# 同时启用金融文档切块器（推荐）
export USE_FINANCIAL_CHUNKER=true
```

### 程序内使用

```python
from haiku.rag.client import HaikuRAG
from haiku.rag.qa.financial_qa import FinancialQuestionAnswerOpenAIAgent

async with HaikuRAG() as client:
    # 自动使用金融问答代理
    agent = FinancialQuestionAnswerOpenAIAgent(client, model="gpt-4")
    
    # 查询会自动识别意图并使用合适的提示词
    answer = await agent.answer("腾讯最新的财务报表显示营收是多少？")
    print(answer)
```

### CLI 使用

```bash
# 通过环境变量启用
export USE_FINANCIAL_QA=true
haiku-rag chat

# 查询示例
> 分析长江和记最新的收购公告
> 这笔交易是否需要股东批准？
> 比较腾讯和阿里巴巴的市盈率
```

## 查询示例

### 1. 财务数据查询

**查询**：
```
腾讯2023年的营收和EBITDA利润率是多少？
```

**输出**：
```
【騰訊控股有限公司】盈利公告

📊 关键财务数据：
- 总收入：人民幣 6,090 億元（同比+10%）
- EBITDA：人民幣 2,511 億元
- EBITDA利润率：41%

📅 重要日期：
- 公告日期：2024年3月20日
- 财年：2023年度

📝 数据说明：
- 所有数据经审计
- 币种：人民币

🔗 信息来源：
基于文档ID: 1234（2023年度报告）
```

### 2. 交易分析

**查询**：
```
分析长江和记收购UK Telecom的交易结构和关键条款
```

**输出**：
```
【交易概要】收购UK Telecom Limited

🏢 交易各方：
- 买方：長江和記實業有限公司（0001.HK）
- 卖方：关连人士（主要股东联系人）
- 目标：UK Telecom Limited（英国电信公司）

💰 交易要素：
- 交易金额：港幣 150 億元
- 收购比例：100%股权
- 支付方式：现金，分三期

📋 关键条款：
1. 支付安排：
   - 首期（40%）：签约时支付港币60亿元
   - 第二期（30%）：监管批准后支付港币45亿元
   - 尾款（30%）：交割完成时支付港币45亿元

2. 先决条件：
   - 获得独立股东批准
   - 获得相关监管批准
   - 完成满意的尽职调查

⚠️ 风险提示：
- 构成关连交易，需要严格合规程序
- 监管批准存在不确定性
- 整合风险需要关注

✅ 后续步骤：
1. 召开独立董事委员会会议
2. 委任独立财务顾问
3. 召开股东特别大会
4. 向监管机构提交申请

🔗 信息来源：
基于2份相关公告文档
```

### 3. 合规检查

**查询**：
```
这笔交易是否构成关连交易？需要满足哪些上市规则要求？
```

**输出**：
```
【合规检查报告】UK Telecom收购交易

✓ 合规确认事项：
- ✅ 已识别为关连交易（卖方为主要股东联系人）
- ✅ 交易公告已包含必需披露信息
- ✅ 已声明需要独立股东批准

⚠️ 需要注意事项：
- 独立董事需要发表意见
- 关连董事须放弃投票
- 需要委任独立财务顾问

📋 适用上市规则：
- 第14A章：关连交易
- 第14章：须予披露交易（主要交易级别）

📅 关键时限：
- 股东大会通知期：至少14个清晰日
- 通函发出期限：公告后21天内
- 股东大会举行：通函发出后28天内

🔗 信息来源：
基于交易公告及上市规则第14A.68条
```

### 4. 比较分析

**查询**：
```
比较腾讯和阿里巴巴最新的市盈率和盈利能力
```

**输出**：
```
【比较分析】腾讯 vs 阿里巴巴

| 指标 | 腾讯（0700.HK） | 阿里巴巴（9988.HK） | 行业平均 |
|------|----------------|-------------------|----------|
| 市盈率 | 18.5x | 15.2x | 22.3x |
| 净利润率 | 31% | 24% | 25% |
| ROE | 22% | 18% | 20% |
| 营收增长 | +10% | +7% | +12% |

📊 关键发现：
1. 腾讯盈利能力更强（净利润率31% vs 24%）
2. 阿里巴巴估值更便宜（PE 15.2x vs 18.5x）
3. 两者均低于行业平均市盈率

💡 分析观点：
- 腾讯的高利润率反映其游戏业务的高毛利特性
- 阿里巴巴的低估值可能反映市场对电商竞争的担忧
- 两家公司都展现了稳健的基本面

🔗 信息来源：
基于2023年度财报数据
```

## 高级功能

### 1. 自定义查询意图

```python
from haiku.rag.qa.financial_prompts import INTENT_PROMPTS

# 添加自定义意图
INTENT_PROMPTS["esg_analysis"] = """
分析ESG（环境、社会、治理）相关信息时，请关注：

【环境因素】
- 碳排放数据
- 环保投入
- 可持续发展目标

【社会责任】
- 员工福利
- 社区贡献
- 供应链管理

【公司治理】
- 董事会结构
- 独立性
- 风险管理
"""
```

### 2. 扩展金融术语

```python
from haiku.rag.qa.financial_prompts import FINANCIAL_TERMS

# 添加新术语
FINANCIAL_TERMS.update({
    "绿色债券": "Green Bond",
    "碳中和": "Carbon Neutral",
    "数字资产": "Digital Asset"
})
```

### 3. 自定义输出格式

```python
from haiku.rag.qa.financial_prompts import ANSWER_FORMATS

# 添加新格式
ANSWER_FORMATS["esg_report"] = """
【ESG报告】{company_name}

🌱 环境表现：
{environmental_data}

👥 社会责任：
{social_data}

🏛️ 公司治理：
{governance_data}

📊 ESG评级：
{esg_rating}

🔗 信息来源：
{source_reference}
"""
```

## 最佳实践

### 1. 查询优化
- 使用具体的公司名称或股票代码
- 明确时间范围（如"2023年"、"最新"）
- 使用标准金融术语

### 2. 数据准确性
- 系统会自动引用源文档
- 数字会保留原始格式和单位
- 重要数据会标注是否经审计

### 3. 合规使用
- 系统识别关连交易等合规要点
- 自动提示监管要求
- 标注关键合规时限

## 性能优化

### 1. 缓存策略
- 常见查询结果缓存
- 金融术语翻译缓存
- 意图识别结果缓存

### 2. 并发处理
- 支持多个查询并发处理
- 自动批量处理相似查询
- 优化大量财务数据提取

### 3. 模型选择
- 简单查询：使用轻量模型（如 gpt-3.5-turbo）
- 复杂分析：使用强大模型（如 gpt-4）
- 本地部署：使用 Ollama + qwen2.5

## 故障排除

### 1. 意图识别错误
- 检查查询是否包含金融关键词
- 可以手动指定查询类型
- 查看 `get_intent_prompt()` 的返回值

### 2. 数据提取不完整
- 确保文档已正确切块（使用金融切块器）
- 增加搜索结果数量限制
- 检查原始文档格式

### 3. 输出格式问题
- 验证模板占位符是否匹配
- 检查数据字段是否完整
- 使用默认格式作为降级方案

## 未来增强

1. **多模态支持**：处理包含图表的PDF公告
2. **实时数据集成**：结合市场数据API
3. **自动报告生成**：定期汇总分析报告
4. **监管更新追踪**：自动识别监管变化
5. **多语言扩展**：支持更多语言的金融术语